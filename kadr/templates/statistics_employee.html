{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Моя статистика посещаемости</h2>
    <span class="badge bg-primary fs-6">Период: {{ start_date|date:"d.m.Y" }} - {{ end_date|date:"d.m.Y" }}</span>
</div>

<!-- Фильтр по датам -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">Фильтр по датам</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3" id="dateFilterForm">
            <div class="col-md-4">
                <label class="form-label">Начальная дата:</label>
                <input type="date" name="start_date" class="form-control" 
                       value="{{ form.start_date.value|date:'Y-m-d' }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Конечная дата:</label>
                <input type="date" name="end_date" class="form-control" 
                       value="{{ form.end_date.value|date:'Y-m-d' }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">Применить фильтр</button>
            </div>
        </form>
        
        <!-- Быстрые кнопки -->
        <div class="mt-3">
            <small class="text-muted">Быстрый выбор:</small>
            <div class="btn-group btn-group-sm mt-1">
                <a href="?current_day=1" class="btn btn-outline-secondary">Сегодня</a>
                <a href="?current_week=1" class="btn btn-outline-secondary">Текущая неделя</a>
                <a href="?current_month=1" class="btn btn-outline-secondary">Текущий месяц</a>
            </div>
        </div>
    </div>
</div>

<div id="statistics-content">
    <!-- Статистика сотрудника -->
    {% for stat in employee_stats %}
    <div class="row mb-4">
        <!-- Карточки статистики -->
        <div class="col-md-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">{{ stat.total_working_days }}</h5>
                    <p class="card-text">Рабочих дней</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">{{ stat.attendances.count }}</h5>
                    <p class="card-text">Заполнено дней</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">{{ stat.status_counts.full|default:0 }}</h5>
                    <p class="card-text">Полных дней</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">{{ stat.status_counts.sick|default:0 }}</h5>
                    <p class="card-text">Больничных</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Детальная статистика -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Детальная статистика</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr>
                            <td><span class="badge bg-success">●</span> Полный день:</td>
                            <td><strong>{{ stat.status_counts.full|default:0 }}</strong></td>
                            <td>дней</td>
                        </tr>
                        <tr>
                            <td><span class="badge bg-warning">●</span> Пол дня:</td>
                            <td><strong>{{ stat.status_counts.half|default:0 }}</strong></td>
                            <td>дней</td>
                        </tr>
                        <tr>
                            <td><span class="badge bg-info">●</span> Отпуск:</td>
                            <td><strong>{{ stat.status_counts.vacation|default:0 }}</strong></td>
                            <td>дней</td>
                        </tr>
                        <tr>
                            <td><span class="badge bg-danger">●</span> Больничный:</td>
                            <td><strong>{{ stat.status_counts.sick|default:0 }}</strong></td>
                            <td>дней</td>
                        </tr>
                        <tr class="table-secondary">
                            <td><strong>Пропущено дней:</strong></td>
                            <td><strong>{{ stat.missing_days }}</strong></td>
                            <td>дней</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <div class="text-center">
                        <h6>Процент присутствия</h6>
                        <div class="progress mb-2" style="height: 30px;">
                            <div class="progress-bar 
                                {% if stat.attendance_percentage >= 90 %}bg-success
                                {% elif stat.attendance_percentage >= 70 %}bg-warning
                                {% else %}bg-danger{% endif %}" 
                                style="width: {{ stat.attendance_percentage }}%">
                                <strong>{{ stat.attendance_percentage|floatformat:1 }}%</strong>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            {% if stat.attendance_percentage >= 90 %}
                                <span class="badge bg-success fs-6">Отлично</span>
                            {% elif stat.attendance_percentage >= 70 %}
                                <span class="badge bg-warning text-dark fs-6">Удовлетворительно</span>
                            {% else %}
                                <span class="badge bg-danger fs-6">Нужно улучшить</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- История посещаемости -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">История посещаемости</h5>
        </div>
        <div class="card-body">
            {% if stat.attendances %}
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Статус</th>
                            <th>День недели</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for attendance in stat.attendances %}
                        <tr>
                            <td>{{ attendance.date|date:"d.m.Y" }}</td>
                            <td>
                                {% if attendance.status == 'full' %}
                                    <span class="badge bg-success">Полный день</span>
                                {% elif attendance.status == 'half' %}
                                    <span class="badge bg-warning text-dark">Пол дня</span>
                                {% elif attendance.status == 'vacation' %}
                                    <span class="badge bg-info">Отпуск</span>
                                {% elif attendance.status == 'sick' %}
                                    <span class="badge bg-danger">Больничный</span>
                                {% else %}
                                    <span class="badge bg-secondary">Не указан</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ attendance.date|date:"l" }}
                                {% if attendance.date == today %}
                                    <span class="badge bg-primary">Сегодня</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center">Нет данных о посещаемости за выбранный период</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Индикатор загрузки -->
<div id="loading" class="text-center" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Загрузка...</span>
    </div>
    <p class="mt-2">Загрузка данных...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Обработка быстрых кнопок через AJAX
    $('.quick-filter').click(function() {
        var period = $(this).data('period');
        loadStatistics(period);
    });

    // Обработка формы через AJAX
    $('#dateFilterForm').submit(function(e) {
        e.preventDefault();
        loadStatistics('custom');
    });

    function loadStatistics(period) {
        $('#loading').show();
        $('#statistics-content').hide();

        var url = window.location.pathname;
        var data = {};

        if (period === 'custom') {
            var startDate = $('input[name="start_date"]').val();
            var endDate = $('input[name="end_date"]').val();
            if (startDate && endDate) {
                data = {
                    'start_date': startDate,
                    'end_date': endDate
                };
            } else {
                alert('Пожалуйста, выберите обе даты');
                $('#loading').hide();
                $('#statistics-content').show();
                return;
            }
        } else {
            // Правильные имена параметров для быстрых кнопок
            if (period === 'day') {
                data['current_day'] = '1';
            } else if (period === 'week') {
                data['current_week'] = '1';
            } else if (period === 'month') {
                data['current_month'] = '1';
            }
        }

        console.log('AJAX запрос:', url, data);

        $.ajax({
            url: url,
            type: 'GET',
            data: data,
            beforeSend: function(xhr) {
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            },
            success: function(response) {
                console.log('AJAX успех:', response);
                
                if (response && response.success) {
                    // Обновляем контент
                    $('#statistics-content').html(response.html);
                    // Обновляем текст периода
                    $('.badge.bg-primary.fs-6').text('Период: ' + response.period_text);
                    // Обновляем даты в форме
                    $('input[name="start_date"]').val(response.start_date);
                    $('input[name="end_date"]').val(response.end_date);
                    // Показываем контент
                    $('#statistics-content').show();
                } else {
                    console.log('Перезагрузка страницы');
                    location.reload();
                }
                $('#loading').hide();
            },
            error: function(xhr, status, error) {
                console.error('AJAX ошибка:', status, error, xhr.responseText);
                alert('Ошибка загрузки данных. Страница будет перезагружена.');
                location.reload();
            }
        });
    }

    // Добавляем активный класс к кнопкам при клике
    $('.quick-filter').click(function() {
        $('.quick-filter').removeClass('active');
        $(this).addClass('active');
    });
});
</script>
{% endblock %}